<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dashboard_admin.css' %}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
</head>
<body>
    <header>
        <h1>Admin Dashboard</h1>
        <nav>
            <ul>
                {% if request.user.role in 'superadmin,eventmanager' %}
                    <li><a href="{% url 'view_alumni_list' %}">Alumni List</a></li>
                {% endif %}
                <li><a href="{% url 'logout' %}">Logout</a></li>
            </ul>            
        </nav>
    </header>

    <div class="container">
        <h2>Welcome, {{ request.user.username }} (Admin)</h2>

        {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
            <div class="flash-message flash-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- === Pending Alumni Approvals === -->
        <div class="section">
            <h2>Pending Alumni Approvals</h2>
            {% if pending_alumni %}
            <p>You can access an alumni's profile by clicking on their name below.</p>
            <div class="table-container">
                <table id="pendingAlumniTable" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Major</th>
                            <th>Graduation Year</th>
                            <th>Action</th>
                        </tr>
                        <tr class="filters">
                            <th><input type="text" placeholder="Name" /></th>
                            <th><input type="text" placeholder="Email" /></th>
                            <th><input type="text" placeholder="Major" /></th>
                            <th><input type="text" placeholder="Year" /></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alumni in pending_alumni %}
                        <tr>
                            <td><a class="alumni-link" href="{% url 'view_alumni_profiles' alumni.id %}">{{ alumni.user.get_full_name }}</a></td>
                            <td>{{ alumni.user.email }}</td>
                            <td>{{ alumni.major }}</td>
                            <td>{{ alumni.graduation_year }}</td>
                            <td>
                                <form action="{% url 'approve_alumni' alumni.user.id %}" method="POST" style="display:inline;">{% csrf_token %}
                                    <button class="approve-btn">Approve</button>
                                </form>
                                <form action="{% url 'decline_alumni' alumni.user.id %}" method="POST" style="display:inline;">{% csrf_token %}
                                    <button class="decline-btn">Reject</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p>No pending alumni approvals at the moment.</p>
            {% endif %}
        </div>
        

        <!-- === Post News === -->
        <div class="post-news">
            <h2>Post News</h2>
            <form action="{% url 'post_news' %}" method="POST">{% csrf_token %}
                <input type="text" name="title" placeholder="News Title" required>
                <textarea name="content" rows="4" placeholder="News Content" required></textarea>
                <button type="submit">Post News</button>
            </form>
        </div>

        <!-- === News Table === -->
        <div class="section">
            <h2>Posted News</h2>
            <div class="table-container">
                <table id="newsTable" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Content</th>
                            <th>Posted By</th>
                            <th>Posted On</th>
                            <th>Actions</th>
                        </tr>
                        <tr class="filters">
                            <th><input type="text" placeholder="Title" /></th>
                            <th><input type="text" placeholder="Content" /></th>
                            <th><input type="text" placeholder="Posted by" /></th>
                            <th><input type="text" placeholder="Date" /></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for news in news_list %}
                        <tr>
                            <td>{{ news.title }}</td>
                            <td>{{ news.content }}</td>
                            <td>{{ news.created_by.get_full_name|default:news.created_by.username }}</td>
                            <td>{{ news.created_at }}</td>
                            <td>
                                <a href="{% url 'edit_news' news.id %}"><button>Edit</button></a>
                                <form action="{% url 'delete_news' news.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">{% csrf_token %}
                                    <button>Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- === Jobs === -->
        <div class="section">
            <h2>Manage Jobs</h2>
            <div class="table-container">
                <table id="jobsTable" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Company</th>
                            <th>Location</th>
                            <th>Posted By</th>
                            <th>Expiration Date</th>
                            <th>Link</th>
                            <th>Actions</th>
                        </tr>
                        <tr class="filters">
                            <th><input type="text" placeholder="Title" /></th>
                            <th><input type="text" placeholder="Company" /></th>
                            <th><input type="text" placeholder="Location" /></th>
                            <th><input type="text" placeholder="Posted By" /></th>
                            <th><input type="text" placeholder="Expiration" /></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in job_list %}
                        <tr>
                            <td>{{ job.job_title }}</td>
                            <td>{{ job.company }}</td>
                            <td>{{ job.location }}</td>
                            <td>{{ job.posted_by.get_full_name|default:job.posted_by.username }}</td>
                            <td>{{ job.expiration_date }}</td>
                            <td>
                                {% if job.registration_link %}
                                    <a href="{{ job.registration_link }}" target="_blank" class="apply-link">Apply</a>
                                {% else %}
                                    <span class="disabled">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'admin_edit_job' job.id %}"><button>Edit</button></a>
                                <form action="{% url 'admin_delete_job' job.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">{% csrf_token %}
                                    <button>Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- === Events === -->
        <div class="section">
            <h2>Manage Events</h2>
            <div class="table-container">
                <table id="eventsTable" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Posted By</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                        <tr class="filters">
                            <th><input type="text" placeholder="Name" /></th>
                            <th><input type="text" placeholder="Location" /></th>
                            <th><input type="text" placeholder="Posted By" /></th>
                            <th><input type="text" placeholder="Date" /></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in event_list %}
                        <tr>
                            <td>{{ event.event_name }}</td>
                            <td>{{ event.location }}</td>
                            <td>{{ event.created_by.get_full_name|default:event.created_by.username }}</td>
                            <td>{{ event.event_date }}</td>
                            <td>
                                <a href="{% url 'admin_edit_event' event.id %}"><button>Edit</button></a>
                                <form action="{% url 'admin_delete_event' event.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">{% csrf_token %}
                                    <button>Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    <!-- === DataTables Initialization Script === -->
    $(document).ready(function () {
        const tables = ['#pendingAlumniTable', '#newsTable', '#jobsTable', '#eventsTable'];
    
        tables.forEach(id => {
            const table = $(id).DataTable({
                scrollX: true,
                paging: true,
                ordering: true,
                autoWidth: false,
                responsive: false,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                dom: '<"top-toolbar"lB>rt<"bottom-toolbar"ip>',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="fas fa-copy"></i> Copy',
                        className: 'btn-icon',
                        exportOptions: {
                            columns: id === '#jobsTable' ? ':not(:last-child)' : ':visible',
                            format: {
                                body: function (data, row, column, node) {
                                    if (column === 5) { // Column index for registration link
                                        return $(node).find('a').attr('href') || "-"; // Extract the href attribute
                                    }
                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn-icon',
                        exportOptions: {
                            columns: id === '#jobsTable' ? ':not(:last-child)' : ':visible',
                            format: {
                                body: function (data, row, column, node) {
                                    if (column === 5) { // Column index for registration link
                                        return $(node).find('a').attr('href') || "-"; // Extract the href attribute
                                    }
                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'csv',
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        className: 'btn-icon',
                        exportOptions: {
                            columns: id === '#jobsTable' ? ':not(:last-child)' : ':visible',
                            format: {
                                body: function (data, row, column, node) {
                                    if (column === 5) { // Column index for registration link
                                        return $(node).find('a').attr('href') || "-"; // Extract the href attribute
                                    }
                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn-icon',
                        exportOptions: {
                            columns: id === '#jobsTable' ? ':not(:last-child)' : ':visible',
                            format: {
                                body: function (data, row, column, node) {
                                    if (column === 5) { // Column index for registration link
                                        return $(node).find('a').attr('href') || "-"; // Extract the href attribute
                                    }
                                    return data;
                                }
                            }
                        }
                    }
                ],
                orderCellsTop: true,
                fixedHeader: true,
                initComplete: function () {
                    const api = this.api();
                    const tableContainer = api.table().container();
                    const filterRow = $(tableContainer).find('thead tr.filters');
        
                    api.columns().every(function (colIdx) {
                        const input = filterRow.find('th').eq(colIdx).find('input');
                        if (input.length) {
                            input.on('input', function () {
                                api.column(colIdx).search(this.value).draw();
                            });
                        }
                    });
                }
            });
        });
    
        setTimeout(() => {
            $('.flash-message').fadeOut();
        }, 5000);
    });
</script>    
</body>
</html>

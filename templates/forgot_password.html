{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Forgot Password</title>
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        .forgot-password-button {
            width: 100%;
            padding: 12px;
            border: none;
            background: #3498db;
            color: white;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        .forgot-password-button:hover {
            background: #2980b9;
        }
        .error-message {
            display: none;
            color: red;
            font-size: 13px;
            margin-top: 5px;
        }
        .hidden {
            display: none;
        }
        .login-link {
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }
        .login-link a {
            color: #3498db;
            text-decoration: none;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .input-icon {
            position: relative;
        }
        .input-icon i.fa-envelope,
        .input-icon i.fa-key,
        .input-icon i.fa-lock {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            z-index: 1;
        }
        .input-icon input {
            padding-left: 35px;
            padding-right: 35px;
            width: 100%;
            box-sizing: border-box;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 2;
            color: #888;
        }
    </style>
</head>
<body>
<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>Forgot Password</h2>
        </div>

        {% if messages %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="flash-message flash-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="POST" action="{% url 'forgot_password' %}">
            {% csrf_token %}
            <input type="hidden" name="step" id="step" value="{{ step|default:'email' }}" />

            <!-- Step 1: Email -->
            <div id="email-section" class="{% if step != 'email' %}hidden{% endif %}">
                <div class="form-group">
                    <p>Enter your email to receive an OTP for password reset</p>
                    <label for="email">Email</label>
                    <div class="input-icon">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" name="email" required placeholder="Enter your email" value="{{ email|default:'' }}"/>
                    </div>
                </div>
                <button type="button" class="forgot-password-button" onclick="submitStep('send_otp')">Send OTP</button>
            </div>

            <!-- Step 2: OTP -->
            <div id="otp-section" class="{% if step != 'otp' %}hidden{% endif %}">
                <div class="form-group">
                    <p>Check your email for OTP.</p>
                    <label for="otp">Enter OTP</label>
                    <div class="input-icon">
                        <i class="fas fa-key"></i>
                        <input type="text" id="otp" name="otp" required placeholder="Enter OTP" />
                    </div>
                </div>
                <button type="button" class="forgot-password-button" onclick="submitStep('verify_otp')">Verify OTP</button>

                <!-- Resend OTP -->
                <button type="button" class="forgot-password-button" style="background-color: #f39c12;" onclick="submitStep('resend_otp')">Resend OTP</button>
            </div>

            <!-- Step 3: Reset Password -->
            <div id="reset-section" class="{% if step != 'reset' %}hidden{% endif %}">
                <div class="form-group">
                    <p>Type a valid password </p>
                    <label for="password">New Password</label>
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" required placeholder="New Password" />
                        <span class="toggle-password" onclick="togglePassword('password', 'eye-icon')">
                            <i id="eye-icon" class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div id="password-error" class="error-message">
                        Password must be at least 8 characters, including 1 uppercase letter, 1 number, and 1 special character.
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm">Confirm Password</label>
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="confirm" name="confirm" required placeholder="Confirm Password" />
                        <span class="toggle-password" onclick="togglePassword('confirm', 'confirm-eye-icon')">
                            <i id="confirm-eye-icon" class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div id="confirm-error" class="error-message">Passwords do not match.</div>
                </div>

                <button type="button" class="forgot-password-button" onclick="submitStep('reset_password')">Reset Password</button>
            </div>
        </form>

        <p class="login-link">Remember your password? <a href="{% url 'login' %}">Login here</a></p>
    </div>
</div>

<script>
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function submitStep(stepValue) {
        document.getElementById('step').value = stepValue;

        if (stepValue === 'reset_password') {
            if (!validateReset()) return;
        }

        document.querySelector('form').submit();
    }

    function validateReset() {
        const pass = document.getElementById("password");
        const confirm = document.getElementById("confirm");
        const passErr = document.getElementById("password-error");
        const confirmErr = document.getElementById("confirm-error");

        const passValid = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(pass.value);
        const confirmMatch = pass.value === confirm.value;

        passErr.style.display = passValid ? "none" : "block";
        confirmErr.style.display = confirmMatch ? "none" : "block";

        return passValid && confirmMatch;
    }

    document.querySelectorAll('.flash-message').forEach(function (msg) {
        setTimeout(() => msg.style.opacity = '0', 4000);
        setTimeout(() => msg.remove(), 5000);
    });
</script>
</body>
</html>
